<div dir='rtl' text-align='justify'>

استخراج مقدار زمان استاندارد از یک توکن زمانی
=============================================

### مقدمه

در راستای توسعه‌ی ابزار [Parstdex](https://github.com/kargaranamir/parstdex) یک patch به منظور **استخراج مقدار استاندارد از یک توکن زمانی** تعبیه شده است. در ادامه به شرح مسئله و روند کار می‌پردازیم.

جمله‌ی زیر را در نظر بگیرید:
*دیروز درست در ساعت پنج و چهل و یک دقیقه صدای گوش خراشی به گوش می‌رسید.*

قصد ما این است که توکنی متناسب با *دیروز* و *ساعت پنج و چهل و یک دقیقه* که حاوی زمان استاندارد باشد استخراج کنیم. بنابراین چند چالش زیر مدنظر است

- تشخیص توکن‌های از جنس زمان در جمله (که همینک در ابزار Parstdex تعبیه شده است)
- ایجاد ارتباط میان توکن‌های تاریخی و توکن‌های زمانی
- تعیین نوع توکن (در مسئله‌ی ما ۳ نوع زمان مدنظر است؛ زمان دقیق، بازه‌ای و کرون‌تایم که نشان‌دهنده‌ی یک رویداد تکرارشونده است)

### ایده

در مسئله‌ای از این دست، اساسا سطح پیچیدگی جملات تا اندازه‌ی دلخواه می‌تواند زیاد شود، لکن جهت سهولت کار فرض‌های زیر را لحاظ کرده‌ایم

- ترتیب آمدن تاریخ و زمان در یک ورودی تغییر نمی‌کند؛ برای نمونه اگر در جمله‌ای ابتدا تاریخ و سپس زمان مشخص می‌شود (مانند سه‌شنبه ساعت ۵ عصر) تا انتهای جمله نیز این ترتیب‌ها حفظ می‌شوند. (و بالعکس)
- در یک جمله می‌توان یک زمان را به چند تاریخ و برای یک تاریخ چند زمان ثبت کرد (با رعایت ترتیب گفته شده در شرط بالا)
- پیچیدگی جملات در حدی نباشد که ابزار Parstdex دچار ایراد در تشخیص توکن‌های زمانی شود
- در زمان‌های بازه‌ای الزاما مبدا نیز ذکر شود (این در حقیقت ازینجا ناشی می‌شود که نشان **از** توسط ابزار فعلی از توکن‌ها حذف می‌شود در نتیجه امکان تمایز میان توکن زمانی دقیق یا مبدا بازه‌ای مشکل می‌شود. پس فرض می‌کنیم که اگر به توکن حاوی عبارات **تا**، **الی** یا **لغایت** رسیدیم، پیشتر از آن مبدا ذکر شده است.)

### پایپلاین

1. `marker`ها و `value`ها با کمک توابع `extract_markers` و `extract_values` به دست می‌ایند.
2. نگاشتی بین تاریخ‌ها و زمان‌ها صورت گیرد.
3. نوع توکن‌ها تعیین شوند.
4. با توجه به مقادیر پیش‌فرض و همچنین زمان حال، برآورد زمانی برای یک توکن انجام شود.
5. بسته‌های نهایی توکنی برای نتیجه‌گیری آماده‌ شوند و خروجی داده شوند.

### کلاس‌ها

##### DatetimeType

این کلاس به صورت Enum تعریف شده و در حقیقت مشخص‌کننده‌ی نوع توکن است که یکی از انواع ذکر شده در بند سوم بخش مقدمه است.

<div dir="ltr">

```python

class DatetimeType(enum.Enum):
    EXACT = -1
    DURATION = [-1, -1]
    CRONTIME = [-1, -1, -1, -1, -1]

```

</div>

##### TokenSpan

در ابزار Parstdex جهت مشخص شدن توکن‌ها از spanهایی به صورت رشته استفاده شده است. جهت سهولت کار با ابتدا و انتهای این spanها و ضمنا بررسی شمول یا عدم شمول یک span کلاس زیر تعریف شده است.

<div dir='ltr'>

```python

class TokenSpan:

    def __init__(self, span: str):
        list_form = span.strip('][').split(', ')
        assert len(list_form) == 2
        self.head = int(list_form[0])
        self.tail = int(list_form[1])
        self.list = span

```

</div>

##### DatetimeToken

این کلاس جهت ساخت یک شیء حاوی اطلاعات موردنیاز نهایی برای یک جفت (تاریخ، زمان) و یا تاریخ به تنهایی است

<div dir='ltr'>

```python

class DatetimeToken:

    def __init__(self, dt_type: DatetimeType, value, date_txt: str, date_span: str, time_txt: str = None,
                 time_span: str = None):
        self.type = dt_type
        self.text = f'{date_txt}'
        self.value = value if value else dt_type.value
        date_span = TokenSpan(date_span)
        if time_span:
            assert time_txt
            self.text += f' {time_txt}'
            time_span = TokenSpan(time_span)
            if date_span.less(time_span):
                self.span = TokenSpan(f'[{date_span.head},{time_span.tail}]')
            else:
                self.span = TokenSpan(f'[{time_span.head},{date_span.tail}]')
        else:
            self.span = date_span

```

</div>

### توابع

#### پرونده‌ی [datetime_determination_util.py](parstdex/datetime_determination_util.py)


##### دسته کردن تاریخ - زمان

<div dir='ltr'>

```python

def group_date_time(date_spans: list, time_spans: list) -> dict

```

</div>

در این تابع لیست spanهای متناظر تاریخ‌ها و زمان‌ها به ترتیب قرارگیری در جمله ورودی گرفته می‌شود و در نهایت یک دیکشنری با کلید‌های تاریخی و لیستی از زمان‌های مربوطه خروجی داده می‌شود. حالت‌هایی که در این تابع بررسی شده‌اند
- نگاشت کردن زمان و تاریخ در حالت ساده
- تخصیص یک تاریخ به چند زمان
- نگاشت کردن یک زمان به چند تاریخ


##### تعیین نوع توکن

<div dir='ltr'>

```python

def det_type(date_txt: str) -> DatetimeType

```

</div>

در این تابع با توجه به حضور یا عدم حضور کلماتی کلیدی موجود در توکن تعیین می‌شود که نوع توکن کدام یک از آن سه حالت است. هنگامی که با یک عبارت زمانی روبرو هستیم برخی کلید واژگان، به سادگی حالت عمومی آن عبارت زمانی را مشخص می‌کنند؛ برخی از این کلید واژگان عبارتند از: هر، ها، سالانه، ماهانه و ... . 

##### برآورد مقدار زمانی یک جفت توکن (حالت دقیق و بازه‌ای)

<div dir='ltr'>

```python

def evaluate_datetime(datetime_type: DatetimeType, date_txt: str = None, time_txt: str = None, date_start: str = None)

```

</div>


##### برآورد مقدار زمانی یک جفت توکن (حالت کرون‌تایم) 


<div dir='ltr'>


```python

def evaluate_crontime(date_txt: str, time_txt: str = None) -> str

```

</div>

### پرونده‌ی [marker_extraction.py](parstdex/marker_extractor.py)

##### استخراج توکن‌های تاریخی-زمانی

<div dir='ltr'>

```python

def extract_datetime_tokens(self, input_sentence: str) -> list

```

</div>

در این تابع توکن‌های زمانی با گذر از پایپلاین ذکر شده ابتدا جفت شده، سپس تعیین نوع می‌شوند و درنهایت برآورد می‌شوند. در انتها نیز حالت تعیین مبدا برای توکن‌های بازه‌ای صورت می‌گیرد.

### نمونه نتایج

مثال‌هایی در [فایل تست](Test.py) موجود است. می‌توانید آن را اجرا کرده و نتایج را مشاهده کنید.

</div>